{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/omarsaleh/Desktop/python/brillianse/frontend/app/profile/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect } from 'react';\nimport Head from 'next/head';\nimport { db, auth, storage } from '../../../lib/firebase'; // <-- Import storage\nimport { doc, getDoc, setDoc } from 'firebase/firestore';\nimport { onAuthStateChanged, User, signOut } from 'firebase/auth';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\n// --- NEW Storage Imports ---\nimport { \n  ref, \n  uploadBytesResumable, \n  getDownloadURL \n} from 'firebase/storage';\n// -------------------------\n\nexport default function Profile() {\n  const [user, setUser] = useState<User | null>(null);\n  const [loading, setLoading] = useState(true);\n  \n  const [error, setError] = useState<string | null>(null);\n  const [validationError, setValidationError] = useState<string | null>(null);\n  const [successMessage, setSuccessMessage] = useState<string | null>(null);\n\n  const [form, setForm] = useState({\n    username: '',\n    twitter: '',\n    linkedin: '',\n    website: '',\n  });\n  \n  const [dailyGroupId, setDailyGroupId] = useState<string | null>(null);\n  \n  // --- NEW Profile Picture State ---\n  const [profilePicUrl, setProfilePicUrl] = useState<string | null>(null); // For the preview\n  const [imageFile, setImageFile] = useState<File | null>(null); // The file to upload\n  const [isUploading, setIsUploading] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  // ---------------------------------\n  \n  const router = useRouter();\n\n  // --- 1. Listen for user and load profile ---\n  useEffect(() => {\n    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {\n      if (currentUser) {\n        setUser(currentUser);\n        const userRef = doc(db, 'users', currentUser.uid);\n        const docSnap = await getDoc(userRef);\n        \n        if (docSnap.exists()) {\n          const data = docSnap.data();\n          let suggestedUsername = data.username || '';\n          if (!data.isProfileComplete) {\n            const name = currentUser.email?.split('@')[0].replace(/[^a-zA-Z0-9]/g, '') || 'user';\n            suggestedUsername = `${name}${Math.floor(100 + Math.random() * 900)}`;\n          }\n          setForm({\n            username: data.username || suggestedUsername,\n            twitter: data.socials?.twitter || '',\n            linkedin: data.socials?.linkedin || '',\n            website: data.socials?.website || '',\n          });\n          setProfilePicUrl(data.profilePictureUrl || null); // <-- Load existing pfp\n          if (data.dailyGroup?.groupId) {\n            setDailyGroupId(data.dailyGroup.groupId);\n          }\n        }\n      } else {\n        router.push('/');\n      }\n      setLoading(false);\n    });\n    return () => unsubscribe();\n  }, [router]);\n  \n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { id, value } = e.target;\n    setForm(prev => ({ ...prev, [id]: value }));\n  };\n  \n  // --- NEW: Handle File Input ---\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      const file = e.target.files[0];\n      setImageFile(file);\n      // Create a local preview URL\n      setProfilePicUrl(URL.createObjectURL(file));\n    }\n  };\n  // ------------------------------\n\n  // --- 2. MODIFIED: Handle Save Profile ---\n  const handleSave = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!user) return;\n\n    setError(null);\n    setSuccessMessage(null);\n    setValidationError(null);\n\n    const { username, twitter, linkedin, website } = form;\n    if (!username) {\n      setValidationError('Username is required.');\n      return;\n    }\n    if (!twitter && !linkedin && !website) {\n      setValidationError('Please add at least one social media handle.');\n      return;\n    }\n\n    try {\n      let finalProfilePicUrl = profilePicUrl; // The URL we will save\n\n      // --- NEW: Upload logic ---\n      if (imageFile) {\n        setIsUploading(true);\n        const storageRef = ref(storage, `profile_pictures/${user.uid}`);\n        const uploadTask = uploadBytesResumable(storageRef, imageFile);\n\n        // Wait for the upload to complete\n        await new Promise<void>((resolve, reject) => {\n          uploadTask.on(\n            'state_changed',\n            (snapshot) => {\n              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;\n              setUploadProgress(progress);\n            },\n            (error) => {\n              console.error('Upload failed:', error);\n              setError('Image upload failed. Please try again.');\n              reject(error);\n            },\n            async () => {\n              // Upload successful, get download URL\n              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);\n              finalProfilePicUrl = downloadURL;\n              setIsUploading(false);\n              setImageFile(null); // Clear the file\n              resolve();\n            }\n          );\n        });\n      }\n      // -------------------------\n\n      const userRef = doc(db, 'users', user.uid);\n      \n      await setDoc(userRef, {\n        username: username,\n        email: user.email,\n        socials: {\n          twitter: twitter,\n          linkedin: linkedin,\n          website: website,\n        },\n        profilePictureUrl: finalProfilePicUrl, // <-- Save the new URL\n        isProfileComplete: true\n      }, { merge: true });\n\n      setSuccessMessage('Profile saved! Redirecting to your group...');\n\n      setTimeout(() => {\n        if (dailyGroupId) {\n          router.push(`/group/${dailyGroupId}`);\n        } else {\n          router.push('/');\n        }\n      }, 2000);\n\n    } catch (err) {\n      if (!isUploading) { // Don't show generic error if upload failed\n        console.error(err);\n        setError('Failed to save profile. Please try again.');\n      }\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  // --- 3. Handle Sign Out ---\n  const handleSignOut = async () => {\n    try {\n      await signOut(auth);\n    } catch (err) {\n      console.error('Failed to sign out:', err);\n    }\n  };\n\n  // --- RENDER LOGIC ---\n  if (loading) {\n    return <main className=\"loading-container\">Loading profile...</main>;\n  }\n\n  return (\n    <main>\n      <Head>\n        <title>My Profile</title>\n      </Head>\n\n      {dailyGroupId && (\n        <div className=\"page-nav-header\">\n          <Link href={`/group/${dailyGroupId}`}>\n            &larr; Back to Your Group\n          </Link>\n        </div>\n      )}\n\n      <form onSubmit={handleSave} className=\"profile-form\">\n        <h1>Your Profile</h1>\n        <p>This is what other users in your group will see.</p>\n\n        {successMessage && <div className=\"success-message\">{successMessage}</div>}\n        {error && <div className=\"error-container\">{error}</div>}\n        {validationError && <div className=\"validation-error\">{validationError}</div>}\n\n        {/* --- NEW: Profile Picture Uploader --- */}\n        <div className=\"pfp-uploader\">\n          <label htmlFor=\"file-input\">\n            <img \n              src={profilePicUrl || '/default-avatar.png'} \n              alt=\"Profile\" \n              className=\"pfp-preview\"\n              onError={(e) => (e.currentTarget.src = 'https://placehold.co/150x150/f0f0f0/333?text=?')}\n            />\n            <span className=\"pfp-edit-text\">Click to change</span>\n          </label>\n          <input \n            id=\"file-input\" \n            type=\"file\" \n            accept=\"image/png, image/jpeg\"\n            onChange={handleFileChange}\n          />\n        </div>\n        \n        {isUploading && (\n          <div className=\"upload-progress-bar\">\n            <div\n              className=\"upload-progress-bar-inner\"\n              style={{ '--progress-width': `${uploadProgress}%` } as React.CSSProperties}\n            ></div>\n          </div>\n        )}\n        {/* ----------------------------------- */}\n\n        <div className=\"input-group\">\n          <label htmlFor=\"username\">Username</label>\n          <input id=\"username\" type=\"text\" value={form.username} onChange={handleChange} />\n        </div>\n        <div className=\"input-group\">\n          <label htmlFor=\"twitter\">Twitter Handle</label>\n          <input id=\"twitter\" type=\"text\" value={form.twitter} onChange={handleChange} />\n        </div>\n        <div className=\"input-group\">\n          <label htmlFor=\"linkedin\">LinkedIn Profile</label>\n          <input id=\"linkedin\" type=\"text\" value={form.linkedin} onChange={handleChange} />\n        </div>\n        <div className=\"input-group\">\n          <label htmlFor=\"website\">Personal Website</label>\n          <input id=\"website\" type=\"text\" value={form.website} onChange={handleChange} />\n        </div>\n\n        <button type=\"submit\" className=\"btn-submit\" disabled={isUploading}>\n          {isUploading ? `Uploading... ${uploadProgress.toFixed(0)}%` : 'Save Profile'}\n        </button>\n      </form>\n\n      <button type=\"button\" onClick={handleSignOut} className=\"btn-sign-out-profile\" disabled={isUploading}>\n        Sign Out\n      </button>\n    </main>\n  );\n}"],"names":[],"mappings":"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"}}]
}